<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åŠ¨æ¼«é«˜æ‰‹ 3.0</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      max-width: 1400px;
      width: 100%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 30px;
    }

    /* âœ… æ ‡é¢˜åŒºï¼šç”¨äºå³ä¸Šè§’æ”¾â€œä¸€é”®é‡ç½®â€ */
    .title-bar {
      position: relative;
      margin-bottom: 20px;
    }

    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 0;
      font-size: 2.5em;
      line-height: 1.2;
    }

    /* âœ… æ ‡é¢˜å³ä¸Šè§’é‡ç½®æŒ‰é’® */
    .top-reset-btn {
      position: absolute;
      right: 0;
      top: 0;
      padding: 10px 14px;
      font-size: 0.95em;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
      white-space: nowrap;
    }

    .top-reset-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.22); }
    .top-reset-btn:active { transform: translateY(0); }

    /* ç©å®¶å±éšè—é¡¶éƒ¨é‡ç½®æŒ‰é’® */
    body.player-locked .top-reset-btn { display: none !important; }

    .role-badge {
      display: inline-block;
      margin-left: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 14px;
      vertical-align: middle;
      background: #eef2ff;
      color: #4338ca;
      border: 1px solid #c7d2fe;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .status-item { font-size: 1.1em; color: #333; }
    .status-item strong { color: #667eea; }

    /* ç©å®¶è®¡åˆ†æ¿ */
    .scoreboard {
      background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .scoreboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 15px;
    }

    .scoreboard h2 {
      color: #ff9800;
      text-align: center;
      font-size: 1.5em;
      margin: 0;
      flex: 1;
    }

    .scoreboard-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
      flex: 0 0 auto;
    }

    .btn-mini {
      padding: 10px 14px;
      font-size: 0.95em;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      white-space: nowrap;
    }

    .btn-mini:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.22); }
    .btn-mini:active { transform: translateY(0); }
    .btn-mini-danger { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; }

    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .player-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .player-info { flex: 1; }
    .player-name { font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 5px; }
    .player-score { font-size: 1.8em; color: #ff9800; font-weight: bold; }

    .score-buttons { display: flex; gap: 5px; flex-direction: column; }

    .score-btn {
      width: 35px;
      height: 35px;
      border: none;
      border-radius: 5px;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .score-btn.plus { background: #4CAF50; color: white; }
    .score-btn.plus:hover { background: #45a049; transform: scale(1.1); }

    .score-btn.minus { background: #f44336; color: white; }
    .score-btn.minus:hover { background: #d32f2f; transform: scale(1.1); }

    .game-area {
      display: flex;
      gap: 30px;
      margin-bottom: 20px;
      align-items: flex-start;
    }

    .image-container {
      flex: 1;
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
    }

    .image-wrapper { position: relative; display: inline-block; width: 100%; }
    #gameImage { width: 100%; height: auto; display: block; }

    .loading {
      color: #666;
      font-size: 1.2em;
      padding: 16px;
      text-align: center;
    }

    .grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      grid-template-rows: repeat(5, 1fr);
      pointer-events: none;
    }

    .grid-cell {
      border: none; /* âœ… ä¸ç”¨ border ç”»ç½‘æ ¼çº¿ */
      outline: 1px solid rgba(255, 255, 255, 0.3);  /* âœ… æ°¸è¿œå­˜åœ¨çš„ç½‘æ ¼çº¿ */
      outline-offset: -1px;                         /* âœ… è´´è¾¹ï¼Œä¸æ‰©å¤§æ ¼å­ */
      cursor: pointer;
      pointer-events: all;
      transition: all 0.25s;
    }

    .grid-cell.selectable:hover { background: rgba(102, 126, 234, 0.3); }

    .grid-cell.selected {
      background: rgba(255, 193, 7, 0.6);
      border: 2px solid #ffc107;
    }

    /* âœ… ç»™ç©å®¶çœ‹çš„â€œæ­ç¤ºâ€ï¼šå¿…é¡»å®Œå…¨é€æ˜ï¼Œéœ²å‡ºåŸå›¾ */
    .grid-cell.revealed {
      background: transparent;
      border: 2px solid rgba(76, 175, 80, 0.95);
      box-shadow: inset 0 0 10px rgba(76, 175, 80, 0.35);
    }

    /* âœ… ä¸»æŒäººå…¨å›¾æ¨¡å¼æç¤ºï¼šä»…ç”¨äºæé†’â€œä¸Šä¸€è½®æ­ç¤ºè¿‡â€ */
    .grid-cell.revealed-hint {
      background: rgba(76, 175, 80, 0.55);
    }

    /* âœ… éšæœºæ­ç¤ºï¼šåŒæ ·ä¸åŠ åº•è‰²ï¼Œåªç”¨è¾¹æ¡†/é˜´å½± */
    .grid-cell.random-revealed {
      background: transparent;
      border: 2px solid rgba(255, 87, 34, 0.95);
      box-shadow: inset 0 0 10px rgba(255, 87, 34, 0.30);
    }

    /* âœ… éšæœºæ­ç¤ºçš„ä¸»æŒäººæç¤º */
    .grid-cell.random-revealed-hint {
      background: rgba(255, 87, 34, 0.55);
    }

    .grid-cell.covered { background: rgba(0, 0, 0, 1); }

    .control-panel {
      flex: 0 0 320px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .btn {
      padding: 14px 22px;
      font-size: 1.05em;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3); }
    .btn:active { transform: translateY(0); }

    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-success { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; }
    .btn-warning { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; }
    .btn-danger  { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; }
    .btn-info    { background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .info-box {
      background: #e3f2fd;
      padding: 14px;
      border-radius: 10px;
      border-left: 4px solid #2196f3;
    }

    .info-box h3 { color: #1976d2; margin-bottom: 10px; }
    .info-box p { color: #555; line-height: 1.6; }

    .info-box a {
      color: #1976d2;
      font-weight: 700;
      text-decoration: underline;
    }

    .selection-count {
      background: #fff3cd;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      color: #856404;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8f9fa;
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
      border-radius: 10px;
      color: #333;
      font-weight: 600;
      user-select: none;
    }

    .toggle-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .config-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .config-modal.active { display: flex; }

    .config-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .config-content h2 { color: #667eea; margin-bottom: 20px; }

    .config-content textarea {
      width: 100%;
      min-height: 300px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .config-buttons { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }

    /* ç©å®¶è®¾ç½®æ¨¡æ€æ¡† */
    .player-setup { margin-bottom: 20px; }

    .player-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
    }

    .player-count-selector { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }

    .count-btn {
      padding: 10px 20px;
      border: 2px solid #667eea;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      color: #667eea;
      transition: all 0.2s;
    }

    .count-btn:hover { background: #667eea; color: white; }
    .count-btn.active { background: #667eea; color: white; }

    .player-names-input { display: none; }
    .player-names-input.active { display: block; }

    /* === ç©å®¶å±é”å®šï¼šå®Œå…¨ä¸å¯æ“ä½œ === */
    body.player-locked .control-panel,
    body.player-locked .config-modal { display: none !important; }

    body.player-locked .grid-overlay { pointer-events: none !important; }
    body.player-locked .score-buttons { display: none !important; }

    @media (max-width: 968px) {
      .game-area { flex-direction: column; }
      .control-panel { flex: 1; }
      .scoreboard-header { flex-direction: column; }
      .scoreboard-actions { width: 100%; justify-content: center; }
      .top-reset-btn { position: static; width: 100%; margin-top: 10px; }
      .title-bar { display: flex; flex-direction: column; gap: 8px; }
    }

    /* âœ… ç©å®¶å±ï¼šå»æ‰ç»¿/çº¢è¾¹æ¡†ä¸å‘å…‰ï¼Œä½†ä¿ç•™ outline ç½‘æ ¼çº¿ */
    body.player-locked .grid-cell.revealed,
    body.player-locked .grid-cell.random-revealed {
      border: none !important;        /* âœ… ä¸è¦ç»¿/çº¢ border */
      box-shadow: none !important;    /* âœ… ä¸è¦å‘å…‰ */
      background: transparent !important;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- âœ… æ ‡é¢˜æ ï¼šå³ä¸Šè§’æ”¾â€œä¸€é”®é‡ç½®â€ -->
    <div class="title-bar">
      <h1>
        ğŸ® åŠ¨æ¼«é«˜æ‰‹ 3.0
        <span class="role-badge" id="roleBadge">role</span>
      </h1>
      <button class="top-reset-btn" id="resetAllBtnTop" onclick="resetAll()">
        â™»ï¸ ä¸€é”®é‡ç½®
      </button>
    </div>

    <!-- ç©å®¶è®¡åˆ†æ¿ -->
    <div class="scoreboard" id="scoreboard" style="display:none;">
      <div class="scoreboard-header">
        <h2>ğŸ† ç©å®¶è®¡åˆ†æ¿</h2>
        <div class="scoreboard-actions" id="scoreboardActions" style="display:none;">
          <button class="btn-mini btn-mini-danger" onclick="clearAllScores()">ğŸ§¹ æ¸…ç©ºåˆ†æ•°</button>
        </div>
      </div>
      <div class="players-grid" id="playersGrid"></div>
    </div>

    <div class="status-bar">
      <div class="status-item">
        <strong>å½“å‰å›¾ç‰‡ï¼š</strong> <span id="currentImage">0</span> / <span id="totalImages">0</span>
      </div>
      <div class="status-item">
        <strong>å½“å‰è½®æ¬¡ï¼š</strong> <span id="currentRound">0</span>
      </div>
      <div class="status-item">
        <strong>å·²å±•ç¤ºæ–¹å—ï¼š</strong> <span id="revealedCount">0</span> / 45
      </div>
    </div>

    <div class="game-area">
      <div class="image-container">
        <div class="image-wrapper" id="imageWrapper">
          <img id="gameImage" src="" alt="æ¸¸æˆå›¾ç‰‡" style="display:none;">
          <div class="grid-overlay" id="gridOverlay"></div>
        </div>
        <div class="loading" id="loadingText">è¯·å…ˆè®¾ç½®ç©å®¶å’Œå›¾ç‰‡</div>
      </div>

      <!-- æ§åˆ¶é¢æ¿ï¼ˆç©å®¶å±ä¼šæ•´ä½“éšè—ï¼‰ -->
      <div class="control-panel" id="controlPanel">
        <!-- âœ… æ–°å¢ï¼šå¸®åŠ©æŒ‰é’®ï¼Œæ”¾åœ¨æ‰“å¼€ç©å®¶æ˜¾ç¤ºå±ä¸Šæ–¹ -->
        <button class="btn btn-info" id="helpBtn" onclick="openHelp()">
          â“ å¸®åŠ©
        </button>

        <button class="btn btn-info" id="openPlayerBtn" onclick="openPlayerScreen()">
          ğŸ–¥ï¸ æ‰“å¼€ç©å®¶æ˜¾ç¤ºå±
        </button>

        <!-- âœ… å·²ç§»é™¤ï¼šåŸæ¥çš„ resetAllBtnï¼ˆé‡ç½®æŒ‰é’®å·²æ”¾åˆ°æ ‡é¢˜å³ä¸Šè§’ï¼‰ -->

        <button class="btn btn-info" id="playerSetupBtn" onclick="openPlayerSetup()">
          ğŸ‘¥ è®¾ç½®ç©å®¶
        </button>

        <button class="btn btn-info" id="configBtn" onclick="openConfig()">
          âš™ï¸ é…ç½®å›¾ç‰‡é“¾æ¥
        </button>

        <label class="toggle-row" title="å¼€å¯åï¼šæ¯è½®ç¡®è®¤é€‰æ‹©ä¼šéšæœºé¢å¤–å±•ç¤º 1 ä¸ªæ–¹å—">
          <input type="checkbox" id="randomExtraToggle" checked onchange="toggleRandomExtra()" />
          éšæœºé¢å¤–å±•ç¤º 1 ä¸ªæ–¹å—
        </label>

        <div class="selection-count" id="selectionCount">
          å·²é€‰æ‹©: 0 ä¸ªæ–¹å—
        </div>

        <button class="btn btn-success" id="showFullBtn" onclick="showFullImage()" disabled>
          ğŸ§© é€‰æ‹©å±•ç¤ºåŒºå—
        </button>

        <button class="btn btn-primary" id="confirmSelectionBtn" onclick="confirmSelection()" disabled>
          âœ… ç¡®è®¤é€‰æ‹©å¹¶å±•ç¤º
        </button>

        <!-- âœ… ä½ç½®è°ƒæ•´ï¼šå…¬å¸ƒç­”æ¡ˆæ”¾åœ¨â€œä¸‹ä¸€å¼ å›¾ç‰‡â€ä¹‹å‰ -->
        <button class="btn btn-warning" id="revealAnswerBtn" onclick="revealAnswerToAll()" disabled>
          ğŸ–¼ï¸ å‘ç©å®¶å±•ç¤ºå®Œæ•´å›¾ç‰‡ï¼ˆå…¬å¸ƒç­”æ¡ˆï¼‰
        </button>

        <button class="btn btn-danger" id="nextImageBtn" onclick="nextImage()" disabled>
          â­ï¸ ä¸‹ä¸€å¼ å›¾ç‰‡
        </button>
      </div>
    </div>
  </div>

  <!-- âœ… æ–°å¢ï¼šå¸®åŠ©å¼¹çª— -->
  <div class="config-modal" id="helpModal">
    <div class="config-content">
      <h2>â“ å¸®åŠ©</h2>
      <div class="info-box" style="margin-bottom: 15px;">
        <p id="instructionText">
          <b>ã€æ¸¸æˆå‰é…ç½®ã€‘</b><br>
          ç‚¹å‡»ã€Œæ‰“å¼€ç©å®¶æ˜¾ç¤ºå±ã€â†’ å°†ç©å®¶çª—å£æŠ•å±ç»™ç©å®¶ï¼ˆå¦‚è…¾è®¯ä¼šè®®å…±äº«ï¼‰â†’ ç‚¹å‡»ã€Œè®¾ç½®ç©å®¶ã€â†’ ç‚¹å‡»ã€Œé…ç½®å›¾ç‰‡é“¾æ¥ã€<br><br>

          <b>ã€æ¸¸æˆè¿›è¡Œä¸­ã€‘</b><br>
          å¯å¤šè½®æ‰§è¡Œï¼šç‚¹å‡»ã€Œé€‰æ‹©å±•ç¤ºåŒºå—ã€â†’ é€‰æ‹©ä»»æ„æ•°é‡åŒºå— â†’ ç‚¹å‡»ã€Œç¡®è®¤é€‰æ‹©å¹¶å±•ç¤ºã€ï¼ˆç©å®¶æŠ¢ç­”ï¼‰<br>
          æ¯å¼ å›¾ç‰‡å¯é‡å¤å¤šè½®ï¼Œç›´åˆ°æœ‰ç©å®¶ç­”å¯¹ <br><br>

          <a href="https://github.com/Davy-Chendy/anime-master-game" target="_blank" rel="noopener noreferrer">ğŸ“– è¯¦ç»†è¯´æ˜ï¼ˆå¯æ„å»ºè‡ªå·±çš„é¢˜åº“ï¼‰</a>
        </p>
      </div>
      <div class="config-buttons">
        <button class="btn btn-warning" onclick="closeHelp()">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- ç©å®¶è®¾ç½®æ¨¡æ€æ¡† -->
  <div class="config-modal" id="playerSetupModal">
    <div class="config-content">
      <h2>ğŸ‘¥ è®¾ç½®ç©å®¶</h2>
      <div class="player-setup">
        <p style="color: #666; margin-bottom: 15px;">è¯·é€‰æ‹©ç©å®¶äººæ•°ï¼š</p>
        <div class="player-count-selector" id="playerCountSelector">
          <button class="count-btn" onclick="selectPlayerCount(2)">2äºº</button>
          <button class="count-btn" onclick="selectPlayerCount(3)">3äºº</button>
          <button class="count-btn" onclick="selectPlayerCount(4)">4äºº</button>
          <button class="count-btn" onclick="selectPlayerCount(5)">5äºº</button>
          <button class="count-btn" onclick="selectPlayerCount(6)">6äºº</button>
          <button class="count-btn" onclick="selectPlayerCount(7)">7äºº</button>
          <button class="count-btn" onclick="selectPlayerCount(8)">8äºº</button>
        </div>

        <div class="player-names-input" id="playerNamesInput">
          <p style="color: #666; margin-bottom: 10px;">è¯·è¾“å…¥ç©å®¶åå­—ï¼š</p>
          <div id="nameInputs"></div>
        </div>
      </div>
      <div class="config-buttons">
        <button class="btn btn-primary" onclick="savePlayerSetup()">ğŸ’¾ ä¿å­˜ç©å®¶è®¾ç½®</button>
        <button class="btn btn-warning" onclick="closePlayerSetup()">âŒ å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- å›¾ç‰‡é…ç½®æ¨¡æ€æ¡† -->
  <div class="config-modal" id="configModal">
    <div class="config-content">
      <h2>âš™ï¸ é…ç½®å›¾ç‰‡é“¾æ¥</h2>

      <a href="https://github.com/Davy-Chendy/anime-master-game"
        target="_blank"
        rel="noopener noreferrer"
        style="display: inline-block; margin: 6px 0 12px; color:#1a73e8; text-decoration: none;">
        ğŸ“– å¦‚ä½•æ„å»ºè‡ªå·±çš„é¢˜åº“
      </a>

      <p style="color: #666; margin-bottom: 15px;">
        æ¯è¡Œä¸€ä¸ªå›¾ç‰‡URLï¼Œæ”¯æŒä»»ä½•å¯è®¿é—®çš„åœ¨çº¿å›¾ç‰‡é“¾æ¥<br>
        ç¤ºä¾‹ï¼šhttps://example.com/pic1.jpg
      </p>

      <textarea id="imageUrlsInput"
        placeholder="è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥ï¼Œæ¯è¡Œä¸€ä¸ª&#10;https://example.com/pic1.jpg&#10;https://example.com/pic2.jpg&#10;..."></textarea>

      <div class="config-buttons">
        <button class="btn btn-info" onclick="loadAuthorExamples()">ğŸ“š ä½¿ç”¨ä½œè€…é¢˜åº“</button>
        <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
        <button class="btn btn-warning" onclick="closeConfig()">âŒ å–æ¶ˆ</button>
      </div>
    </div>
  </div>


  <script>
    /**
     * åŒå±ä¸»æŒäººæ¨¡å¼ï¼ˆåŒæœºåŒçª—å£ï¼‰
     * - role=hostï¼šå¯æ“ä½œï¼ˆé»˜è®¤ï¼‰
     * - role=playerï¼šå®Œå…¨ä¸å¯æ“ä½œï¼Œåªæ¥æ”¶ host å¹¿æ’­çš„çŠ¶æ€å¹¶æ¸²æŸ“
     */
    const params = new URLSearchParams(location.search);
    const ROLE = (params.get('role') || 'host').toLowerCase();
    const IS_HOST = ROLE !== 'player';

    const CHANNEL_NAME = 'anime-game-sync-v4';
    const channel = new BroadcastChannel(CHANNEL_NAME);

    // æ¸¸æˆçŠ¶æ€
    let currentImageIndex = 0;
    let currentRound = 0;
    let selectedCells = [];
    let revealedCells = new Set();
    let randomRevealedCells = new Set();
    let isFullImageMode = false;
    let imageUrls = [];
    let players = [];
    let randomExtraEnabled = true;

    // âœ… æ–°å¢ï¼šç­”æ¡ˆå…¬å¸ƒæ€ï¼ˆä¸€æ¬¡æ€§ï¼Œä¸æä¾›å…³é—­ï¼›ä¸‹ä¸€å¼ å›¾ä¼šè‡ªåŠ¨é€€å‡ºï¼‰
    let answerRevealed = false;

    const ROWS = 5, COLS = 9;
    const TOTAL_CELLS = ROWS * COLS;

    // âœ… å¸®åŠ©å¼¹çª—
    function openHelp() {
      if (!IS_HOST) return;
      document.getElementById('helpModal').classList.add('active');
    }
    function closeHelp() {
      document.getElementById('helpModal').classList.remove('active');
    }

    // ========== åŒæ­¥ ==========
    function getGameState() {
      return {
        v: 4,
        ts: Date.now(),
        currentImageIndex,
        currentRound,
        imageUrls,
        players,
        revealedCells: Array.from(revealedCells),
        randomRevealedCells: Array.from(randomRevealedCells),
        randomExtraEnabled,
        answerRevealed
      };
    }

    function broadcastState(reason = '') {
      if (!IS_HOST) return;
      channel.postMessage({ type: 'state', reason, state: getGameState() });
    }

    function applyGameState(state) {
      if (Array.isArray(state.imageUrls)) imageUrls = state.imageUrls;
      if (Array.isArray(state.players)) players = state.players;

      if (typeof state.randomExtraEnabled === 'boolean') {
        randomExtraEnabled = state.randomExtraEnabled;
        const toggle = document.getElementById('randomExtraToggle');
        if (toggle) toggle.checked = randomExtraEnabled;
      }

      if (typeof state.answerRevealed === 'boolean') {
        answerRevealed = state.answerRevealed;
      }

      const nextImageIndex = Number(state.currentImageIndex || 0);
      const nextRound = Number(state.currentRound || 0);
      const nextRevealed = new Set(Array.isArray(state.revealedCells) ? state.revealedCells : []);
      const nextRandom = new Set(Array.isArray(state.randomRevealedCells) ? state.randomRevealedCells : []);

      currentRound = nextRound;
      revealedCells = nextRevealed;
      randomRevealedCells = nextRandom;

      renderScoreboard();

      // ç¡®ä¿ç©å®¶ç«¯å›¾ç‰‡èƒ½æ˜¾ç¤ºï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦ load
      const img = document.getElementById('gameImage');
      const targetUrl = (imageUrls && imageUrls.length > 0) ? imageUrls[nextImageIndex] : '';
      const alreadyLoadedThis =
        !!img.src && !!targetUrl && (img.src === targetUrl || img.src.includes(targetUrl));
      const needLoad = !!targetUrl && (!alreadyLoadedThis || nextImageIndex !== currentImageIndex);

      currentImageIndex = nextImageIndex;

      if (imageUrls.length > 0) {
        if (needLoad) {
          ensureGrid();
          coverAllCells(); // é˜²é—ª
          loadImage(currentImageIndex, () => {
            ensureGrid();
            renderGridFromState();
            updateStatus();
            updateButtonsByState();
          });
        } else {
          ensureGrid();
          renderGridFromState();
          updateStatus();
          updateButtonsByState();
        }
      } else {
        updateStatus();
        updateButtonsByState();
      }
    }

    channel.onmessage = (ev) => {
      const msg = ev.data;
      if (!msg) return;

      if (msg.type === 'state') {
        if (IS_HOST) return;
        if (!msg.state) return;
        applyGameState(msg.state);
      }

      if (msg.type === 'request_state') {
        if (!IS_HOST) return;
        broadcastState('player_request_state');
      }
    };

    // ========== åˆå§‹åŒ– ==========
    function init() {
      document.getElementById('roleBadge').textContent = IS_HOST ? 'ä¸»æŒäººå±ï¼ˆHOSTï¼‰' : 'ç©å®¶å±ï¼ˆPLAYERï¼‰';

      if (!IS_HOST) {
        document.body.classList.add('player-locked');
        isFullImageMode = false;
      } else {
        const savedToggle = localStorage.getItem('animeGameRandomExtraEnabled');
        if (savedToggle !== null) randomExtraEnabled = (savedToggle === 'true');
        const toggle = document.getElementById('randomExtraToggle');
        if (toggle) toggle.checked = randomExtraEnabled;
      }

      const savedPlayers = localStorage.getItem('animeGamePlayers');
      if (savedPlayers) players = JSON.parse(savedPlayers);

      const savedUrls = localStorage.getItem('animeGameImageUrls');
      if (savedUrls) imageUrls = JSON.parse(savedUrls);

      renderScoreboard();
      ensureGrid();
      updateSelectionCount();
      updateStatus();

      // è®¡åˆ†æ¿æ¸…ç©ºæŒ‰é’®ä»… Host æ˜¾ç¤º
      document.getElementById('scoreboardActions').style.display = IS_HOST ? 'flex' : 'none';

      if (IS_HOST) {
        if (imageUrls.length > 0 && players.length > 0) {
          loadImage(0, () => {
            document.getElementById('showFullBtn').disabled = false;
            document.getElementById('nextImageBtn').disabled = false;
            document.getElementById('revealAnswerBtn').disabled = false;
            updateButtonsByState();
            broadcastState('init');
          });
        } else {
          updateButtonsByState();
        }
      } else {
        channel.postMessage({ type: 'request_state', ts: Date.now() });
      }

      if (!IS_HOST) {
        const btn = document.getElementById('openPlayerBtn');
        if (btn) btn.style.display = 'none';
        const helpBtn = document.getElementById('helpBtn');
        if (helpBtn) helpBtn.style.display = 'none';
      }
    }

    function updateButtonsByState() {
      if (!IS_HOST) return;

      const hasReady = (imageUrls.length > 0 && players.length > 0);
      const showFullBtn = document.getElementById('showFullBtn');
      const confirmBtn = document.getElementById('confirmSelectionBtn');
      const nextBtn = document.getElementById('nextImageBtn');
      const revealBtn = document.getElementById('revealAnswerBtn');

      if (!showFullBtn || !confirmBtn || !nextBtn || !revealBtn) return;

      // å…¬å¸ƒç­”æ¡ˆåï¼šé”ä½â€œé€‰å—/ç¡®è®¤â€ï¼Œåªå‰©â€œä¸‹ä¸€å¼ å›¾ç‰‡â€
      if (answerRevealed) {
        showFullBtn.disabled = true;
        confirmBtn.disabled = true;
        revealBtn.disabled = true; // ä¸€æ¬¡æ€§åŠ¨ä½œï¼Œä¸å†å…è®¸é‡å¤ç‚¹
        nextBtn.disabled = !hasReady;
        return;
      }

      // æœªå…¬å¸ƒï¼šæ ¹æ®å¸¸è§„å¯ç”¨æ€§
      showFullBtn.disabled = !hasReady || isFullImageMode;
      nextBtn.disabled = !hasReady;
      revealBtn.disabled = !hasReady;

      // confirmBtn ç”± updateSelectionCount æ§åˆ¶ï¼ˆéœ€é€‰ >0ï¼‰
      updateSelectionCount();
    }

    // ========== Hostï¼šä¸€é”®æ‰“å¼€ç©å®¶å± ==========
    function openPlayerScreen() {
      if (!IS_HOST) return;
      const url = new URL(window.location.href);
      url.searchParams.set('role', 'player');
      const w = window.open(url.toString(), 'animeGamePlayer', 'noopener,noreferrer');
      if (!w) {
        alert('æµè§ˆå™¨æ‹¦æˆªäº†å¼¹çª—ã€‚è¯·å…è®¸å¼¹çª—åé‡è¯•ï¼Œæˆ–æ‰‹åŠ¨æ‰“å¼€ï¼š\n' + url.toString());
        return;
      }
      setTimeout(() => { try { w.focus(); } catch (e) { } }, 200);
    }

    // ========== ä¸€é”®é‡ç½® ==========
    function resetAll() {
      if (!IS_HOST) return;
      if (!confirm('ç¡®å®šè¦ä¸€é”®é‡ç½®å—ï¼Ÿè¿™ä¼šæ¸…ç©ºç©å®¶ã€åˆ†æ•°ã€å›¾ç‰‡é…ç½®ã€å¼€å…³çŠ¶æ€ï¼Œå¹¶å›åˆ°åˆå§‹ç•Œé¢ã€‚')) return;

      localStorage.removeItem('animeGamePlayers');
      localStorage.removeItem('animeGameImageUrls');
      localStorage.removeItem('animeGameRandomExtraEnabled');

      players = [];
      imageUrls = [];
      currentImageIndex = 0;
      currentRound = 0;
      selectedCells = [];
      revealedCells.clear();
      randomRevealedCells.clear();
      isFullImageMode = false;
      randomExtraEnabled = true;
      answerRevealed = false;

      renderScoreboard();
      ensureGrid(true);
      coverAllCells();
      updateSelectionCount();
      updateStatus();
      updateButtonsByState();

      const img = document.getElementById('gameImage');
      const wrapper = document.getElementById('imageWrapper');
      const loading = document.getElementById('loadingText');
      img.src = '';
      img.style.display = 'none';
      wrapper.style.display = 'none';
      loading.style.display = 'block';
      loading.textContent = 'è¯·å…ˆè®¾ç½®ç©å®¶å’Œå›¾ç‰‡';

      closeConfig();
      closePlayerSetup();
      closeHelp();

      broadcastState('reset_all');
      alert('å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€ã€‚');
    }

    // ========== æ¸…ç©ºåˆ†æ•° ==========
    function clearAllScores() {
      if (!IS_HOST) return;
      if (players.length === 0) {
        alert('è¿˜æ²¡æœ‰ç©å®¶ã€‚');
        return;
      }
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç©å®¶åˆ†æ•°å—ï¼Ÿ')) return;

      players = players.map(p => ({ ...p, score: 0 }));
      localStorage.setItem('animeGamePlayers', JSON.stringify(players));
      renderScoreboard();
      broadcastState('clear_scores');
    }

    // ========== éšæœºé¢å¤–å±•ç¤ºå¼€å…³ ==========
    function toggleRandomExtra() {
      if (!IS_HOST) return;
      const toggle = document.getElementById('randomExtraToggle');
      randomExtraEnabled = !!toggle.checked;
      localStorage.setItem('animeGameRandomExtraEnabled', String(randomExtraEnabled));
      broadcastState('toggle_random_extra');
    }

    // ========== ç©å®¶è®¾ç½®ç›¸å…³ ==========
    function openPlayerSetup() {
      if (!IS_HOST) return;
      document.getElementById('playerSetupModal').classList.add('active');
    }

    function closePlayerSetup() {
      document.getElementById('playerSetupModal').classList.remove('active');
    }

    function selectPlayerCount(count) {
      if (!IS_HOST) return;
      document.querySelectorAll('.count-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      const container = document.getElementById('nameInputs');
      container.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'player-input';
        input.placeholder = `ç©å®¶ ${i + 1} çš„åå­—`;
        input.value = players[i] ? players[i].name : '';
        container.appendChild(input);
      }
      document.getElementById('playerNamesInput').classList.add('active');
    }

    function savePlayerSetup() {
      if (!IS_HOST) return;
      const inputs = document.querySelectorAll('#nameInputs .player-input');
      if (inputs.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©ç©å®¶äººæ•°ï¼');
        return;
      }

      const newPlayers = [];
      let hasEmpty = false;

      inputs.forEach((input, index) => {
        const name = input.value.trim();
        if (!name) { hasEmpty = true; return; }
        newPlayers.push({ name, score: players[index] ? players[index].score : 0 });
      });

      if (hasEmpty) {
        alert('è¯·å¡«å†™æ‰€æœ‰ç©å®¶çš„åå­—ï¼');
        return;
      }

      players = newPlayers;
      localStorage.setItem('animeGamePlayers', JSON.stringify(players));
      renderScoreboard();
      closePlayerSetup();

      if (imageUrls.length > 0) {
        document.getElementById('showFullBtn').disabled = false;
        document.getElementById('nextImageBtn').disabled = false;
        document.getElementById('revealAnswerBtn').disabled = false;
      }

      updateButtonsByState();
      broadcastState('save_players');
      alert(`æˆåŠŸè®¾ç½® ${players.length} ä½ç©å®¶ï¼`);
    }

    function renderScoreboard() {
      const container = document.getElementById('playersGrid');
      container.innerHTML = '';

      if (players.length === 0) {
        document.getElementById('scoreboard').style.display = 'none';
        return;
      }

      document.getElementById('scoreboard').style.display = 'block';

      players.forEach((player, index) => {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.innerHTML = `
          <div class="player-info">
            <div class="player-name">${escapeHtml(player.name)}</div>
            <div class="player-score">${player.score} åˆ†</div>
          </div>
          <div class="score-buttons">
            <button class="score-btn plus" onclick="addScore(${index}, 1)">+</button>
            <button class="score-btn minus" onclick="addScore(${index}, -1)">âˆ’</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function addScore(playerIndex, delta) {
      if (!IS_HOST) return;
      players[playerIndex].score += delta;
      if (players[playerIndex].score < 0) players[playerIndex].score = 0;
      localStorage.setItem('animeGamePlayers', JSON.stringify(players));
      renderScoreboard();
      broadcastState('score_change');
    }

    // ========== å›¾ç‰‡é…ç½®ç›¸å…³ ==========
    function openConfig() {
      if (!IS_HOST) return;
      document.getElementById('configModal').classList.add('active');
      document.getElementById('imageUrlsInput').value = imageUrls.join('\n');
    }

    function closeConfig() {
      document.getElementById('configModal').classList.remove('active');
    }

    async function loadAuthorExamples() {
      if (!IS_HOST) return;

      const textarea = document.getElementById('imageUrlsInput');
      textarea.value = 'è¯»å– examples.txt ä¸­...';

      try {
        const res = await fetch('./examples.txt', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();

        const urls = text
          .split(/\r?\n/)
          .map(s => s.trim())
          .filter(s => s.length > 0 && !s.startsWith('#'));

        if (urls.length === 0) {
          textarea.value = '';
          alert('examples.txt ä¸ºç©ºæˆ–æ²¡æœ‰æœ‰æ•ˆé“¾æ¥ã€‚');
          return;
        }

        textarea.value = urls.join('\n');
        alert(`å·²åŠ è½½ä½œè€…é¢˜åº“ï¼š${urls.length} æ¡é“¾æ¥ã€‚`);
      } catch (e) {
        console.error(e);
        textarea.value = '';
        alert(
          'è¯»å– examples.txt å¤±è´¥ã€‚\n' +
          'è¯·ç¡®è®¤ examples.txt ä¸ index.html åœ¨åŒä¸€ç›®å½•ï¼Œå¹¶é€šè¿‡ http(s) æ–¹å¼è¿è¡Œï¼ˆä¾‹å¦‚ GitHub Pages æˆ– python -m http.serverï¼‰ã€‚'
        );
      }
    }

    function saveConfig() {
      if (!IS_HOST) return;
      const input = document.getElementById('imageUrlsInput').value;
      const urls = input.split('\n').map(u => u.trim()).filter(u => u.length > 0);

      if (urls.length === 0) {
        alert('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªå›¾ç‰‡é“¾æ¥ï¼');
        return;
      }

      imageUrls = urls;
      localStorage.setItem('animeGameImageUrls', JSON.stringify(imageUrls));

      // é…ç½®æ›´æ–°ï¼šé€€å‡ºç­”æ¡ˆå…¬å¸ƒæ€ï¼Œå›åˆ°æ­£å¸¸æµç¨‹
      answerRevealed = false;

      resetProgressForNewImage(0);

      loadImage(0, () => {
        ensureGrid(true);
        renderGridFromState();
        updateStatus();
        updateButtonsByState();

        if (players.length > 0) {
          document.getElementById('showFullBtn').disabled = false;
          document.getElementById('nextImageBtn').disabled = false;
          document.getElementById('revealAnswerBtn').disabled = false;
        }

        document.getElementById('confirmSelectionBtn').disabled = true;

        updateSelectionCount();
        broadcastState('save_config');
        closeConfig();
        alert(`æˆåŠŸåŠ è½½ ${imageUrls.length} å¼ å›¾ç‰‡ï¼`);
      });
    }

    function resetProgressForNewImage(index) {
      currentImageIndex = index;
      currentRound = 0;
      selectedCells = [];
      revealedCells.clear();
      randomRevealedCells.clear();
      isFullImageMode = false;
    }

    function loadImage(index, onDone) {
      if (index < 0 || index >= imageUrls.length) {
        if (IS_HOST) alert('å›¾ç‰‡ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼');
        return;
      }

      const img = document.getElementById('gameImage');
      const wrapper = document.getElementById('imageWrapper');
      const loading = document.getElementById('loadingText');

      loading.textContent = 'åŠ è½½ä¸­...';
      loading.style.display = 'block';
      wrapper.style.display = 'none';

      // âœ… é˜²é—ªï¼šå…ˆç›–é»‘ã€éšè—å›¾å±‚
      ensureGrid();
      coverAllCells();
      img.style.display = 'none';
      wrapper.style.display = 'none';

      img.onload = function () {
        loading.style.display = 'none';
        wrapper.style.display = 'inline-block';
        img.style.display = 'block';
        syncGridOverlay();
        if (typeof onDone === 'function') onDone();
      };

      img.onerror = function () {
        loading.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥';
        loading.style.display = 'block';
        wrapper.style.display = 'none';
        if (typeof onDone === 'function') onDone();
      };

      img.src = imageUrls[index];
    }

    function syncGridOverlay() {
      const img = document.getElementById('gameImage');
      const overlay = document.getElementById('gridOverlay');
      overlay.style.width = img.offsetWidth + 'px';
      overlay.style.height = img.offsetHeight + 'px';
    }

    window.addEventListener('resize', function () {
      if (document.getElementById('gameImage').style.display !== 'none') {
        syncGridOverlay();
      }
    });

    function ensureGrid(forceRecreate = false) {
      const overlay = document.getElementById('gridOverlay');
      if (!overlay) return;
      if (forceRecreate || overlay.children.length !== TOTAL_CELLS) createGrid();
    }

    function createGrid() {
      const overlay = document.getElementById('gridOverlay');
      overlay.innerHTML = '';
      for (let i = 0; i < TOTAL_CELLS; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell covered';
        cell.dataset.index = i;
        cell.onclick = () => selectCell(i);
        overlay.appendChild(cell);
      }
    }

    function coverAllCells() {
      const cells = document.querySelectorAll('.grid-cell');
      cells.forEach(cell => {
        cell.classList.remove(
          'selectable', 'selected',
          'revealed', 'revealed-hint',
          'random-revealed', 'random-revealed-hint'
        );
        cell.classList.add('covered');
      });
    }

    // ========== å‡ºé¢˜æµç¨‹ï¼šä»»æ„æ•°é‡ ==========
    function showFullImage() {
      if (!IS_HOST) return;
      if (answerRevealed) return; // å…¬å¸ƒç­”æ¡ˆåä¸å…è®¸å†è¿›å…¥é€‰å—

      selectedCells = [];
      isFullImageMode = true;

      document.getElementById('showFullBtn').disabled = true;

      updateSelectionCount();
      renderGridFromState();
      updateButtonsByState();
    }

    function selectCell(index) {
      if (!IS_HOST) return;
      if (!isFullImageMode) return;
      if (answerRevealed) return;
      if (revealedCells.has(index) || randomRevealedCells.has(index)) return;

      const cell = document.querySelectorAll('.grid-cell')[index];
      if (selectedCells.includes(index)) {
        selectedCells = selectedCells.filter(i => i !== index);
        cell.classList.remove('selected');
      } else {
        selectedCells.push(index);
        cell.classList.add('selected');
      }

      updateSelectionCount();
    }

    function updateSelectionCount() {
      const el = document.getElementById('selectionCount');
      if (el) el.textContent = `å·²é€‰æ‹©: ${selectedCells.length} ä¸ªæ–¹å—`;

      const confirmBtn = document.getElementById('confirmSelectionBtn');
      if (confirmBtn) {
        confirmBtn.disabled = !(IS_HOST && isFullImageMode && selectedCells.length > 0 && !answerRevealed);
      }
    }

    function confirmSelection() {
      if (!IS_HOST) return;
      if (!isFullImageMode) return;
      if (answerRevealed) return;
      if (selectedCells.length <= 0) return;

      selectedCells.forEach(index => revealedCells.add(index));

      if (randomExtraEnabled) {
        const available = [];
        for (let i = 0; i < TOTAL_CELLS; i++) {
          if (!revealedCells.has(i) && !randomRevealedCells.has(i)) available.push(i);
        }
        if (available.length > 0) {
          const rand = available[Math.floor(Math.random() * available.length)];
          randomRevealedCells.add(rand);
          revealedCells.add(rand);
        }
      }

      currentRound++;
      selectedCells = [];
      isFullImageMode = false;

      document.getElementById('confirmSelectionBtn').disabled = true;
      document.getElementById('showFullBtn').disabled = false;

      updateSelectionCount();
      renderGridFromState();
      updateStatus();
      updateButtonsByState();
      broadcastState('confirm_selection');
    }

    // âœ… æ–°å¢ï¼šä¸€æ¬¡æ€§å…¬å¸ƒç­”æ¡ˆï¼ˆHost/Player åŒæ­¥å…¨å›¾ï¼‰
    function revealAnswerToAll() {
      if (!IS_HOST) return;
      if (imageUrls.length === 0) return;

      answerRevealed = true;
      isFullImageMode = false;
      selectedCells = [];

      // å…¬å¸ƒåç›´æ¥å…¨å›¾
      renderGridFromState();
      updateButtonsByState();
      broadcastState('reveal_answer');
    }

    // ========== ä¸‹ä¸€å¼  ==========
    function nextImage() {
      if (!IS_HOST) return;

      // âœ… è‹¥å·²å…¬å¸ƒç­”æ¡ˆï¼Œåˆ™ç›´æ¥è¿›å…¥ä¸‹ä¸€å¼ ï¼Œä¸å¼¹ç¡®è®¤æ¡†
      if (!answerRevealed) {
        if (!confirm('ç¡®å®šè¦è¿›å…¥ä¸‹ä¸€å¼ å›¾ç‰‡å—ï¼Ÿå½“å‰è¿›åº¦å°†é‡ç½®ã€‚')) return;
      }

      currentImageIndex++;
      if (currentImageIndex >= imageUrls.length) currentImageIndex = 0;

      resetProgressForNewImage(currentImageIndex);

      // âœ… ä¸‹ä¸€å¼ å›¾è‡ªåŠ¨é€€å‡ºâ€œå…¬å¸ƒç­”æ¡ˆæ€â€
      answerRevealed = false;

      // âœ… åŒä¿é™©ï¼šåˆ‡å›¾å‰å…ˆå…¨éƒ¨ç›–é»‘
      ensureGrid();
      coverAllCells();

      loadImage(currentImageIndex, () => {
        ensureGrid(true);
        renderGridFromState();

        document.getElementById('showFullBtn').disabled = false;
        document.getElementById('confirmSelectionBtn').disabled = true;

        updateStatus();
        updateSelectionCount();
        updateButtonsByState();
        broadcastState('next_image');
      });
    }

    // ========== æ¸²æŸ“ ==========
    function renderGridFromState() {
      const cells = document.querySelectorAll('.grid-cell');
      if (!cells || cells.length === 0) return;

      const inHostSelectMode = (IS_HOST && isFullImageMode);

      // âœ… å…¬å¸ƒç­”æ¡ˆï¼šHost/Player éƒ½å…¨å›¾
      if (answerRevealed) {
        cells.forEach(cell => {
          cell.classList.remove(
            'selectable', 'selected',
            'revealed', 'revealed-hint',
            'random-revealed', 'random-revealed-hint',
            'covered'
          );
        });
        return;
      }

      cells.forEach((cell, index) => {
        cell.classList.remove(
          'selectable', 'selected',
          'revealed', 'revealed-hint',
          'random-revealed', 'random-revealed-hint'
        );

        if (inHostSelectMode) {
          cell.classList.remove('covered');
          cell.classList.add('selectable');

          if (selectedCells.includes(index)) cell.classList.add('selected');

          if (revealedCells.has(index)) cell.classList.add('revealed-hint');
          if (randomRevealedCells.has(index)) cell.classList.add('random-revealed-hint');
        }

        if (revealedCells.has(index)) {
          cell.classList.remove('covered');
          if (randomRevealedCells.has(index)) cell.classList.add('random-revealed');
          else cell.classList.add('revealed');
          return;
        }

        if (!inHostSelectMode) cell.classList.add('covered');
      });
    }

    function updateStatus() {
      document.getElementById('currentImage').textContent = imageUrls.length ? (currentImageIndex + 1) : 0;
      document.getElementById('totalImages').textContent = imageUrls.length;
      document.getElementById('currentRound').textContent = currentRound;
      document.getElementById('revealedCount').textContent = revealedCells.size;

      if (IS_HOST) {
        const ready = (imageUrls.length > 0 && players.length > 0);
        document.getElementById('revealAnswerBtn').disabled = !ready || answerRevealed;
      }
    }

    // ========== å°å·¥å…· ==========
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    window.onload = init;
  </script>
</body>

</html>
